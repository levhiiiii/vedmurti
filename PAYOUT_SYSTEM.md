# Automatic Payout System Documentation

## Overview

The automatic payout system has been implemented to handle payouts for the Vedmurti Affiliate program. Payouts are automatically generated on scheduled dates (2nd, 12th, and 22nd of each month) for users who have completed KYC and have positive income.

## Key Features

### 1. Automatic Payout Generation
- **Schedule**: Payouts are automatically generated on the 2nd, 12th, and 22nd of each month
- **Time Zone**: Asia/Kolkata (IST)
- **Trigger**: Cloud Function scheduled with cron expression `0 0 2,12,22 * *`

### 2. Eligibility Criteria
- User must have KYC completed (`kycCompleted: true`)
- User must have a primary bank account added
- User must have positive total income (Promotional + Leadership + Rewards)

### 3. Payout Calculation
- **Total Income**: Sum of Promotional Income + Leadership Income + Rewards Income
- **Deduction**: 5% of total income
- **Payout Amount**: 95% of total income (after 5% deduction)

### 4. Income Reset
After payout generation, all user incomes are reset to zero:
- Promotional Income: 0
- Leadership Income: 0
- Rewards Income: 0
- Daily Pairs: 0
- Daily Income: 0

## System Components

### 1. Cloud Functions (`functions/index.js`)

#### `generateAutomaticPayouts`
- **Type**: Scheduled Cloud Function
- **Schedule**: `0 0 2,12,22 * *` (2nd, 12th, 22nd at midnight IST)
- **Functionality**:
  - Fetches all users with KYC completed
  - Checks for primary bank account
  - Calculates total income from MLM data
  - Creates payout records in `payouts` collection
  - Resets user income after payout generation
  - Creates payout summary

#### `manualPayoutGeneration`
- **Type**: HTTP Cloud Function
- **Purpose**: Manual trigger for testing payout generation
- **Authentication**: Requires admin secret key

#### `getPayoutStatistics`
- **Type**: HTTP Cloud Function
- **Purpose**: Get payout statistics for admin dashboard

#### `updatePayoutStatus`
- **Type**: HTTP Cloud Function
- **Purpose**: Update payout status (pending → completed/rejected)

### 2. Payout Service (`src/services/payoutService.js`)

#### Key Methods:
- `generateAutomaticPayouts()`: Generate payouts for all eligible users
- `calculateUserTotalIncome(userId)`: Calculate total income from all sources
- `resetUserIncome(userId)`: Reset user income after payout
- `getAllPayouts()`: Get all payouts for admin
- `getPayoutsByStatus(status)`: Get payouts filtered by status
- `updatePayoutStatus(payoutId, status)`: Update payout status
- `exportPayoutsToCSV(payouts)`: Export payouts to Excel format

### 3. Admin Payout Management (`src/pages/Admin/pages/PayoutManagement.jsx`)

#### Features:
- View all payouts with user and bank details
- Filter payouts by status (all, pending, completed, rejected)
- Search payouts by user name, email, or referral code
- Update payout status (pending → completed/rejected)
- Export payouts to Excel with complete details
- Manual payout generation trigger
- Payout statistics dashboard

### 4. KYC Integration (`src/pages/Affilate/pages/KYC.jsx`)

#### KYC Completion:
- When user adds their first bank account, they are automatically marked as KYC completed
- Updates `users` collection with `kycCompleted: true` and `kycCompletedAt` timestamp

## Database Collections

### 1. `payouts` Collection
```javascript
{
  userId: string,
  userEmail: string,
  userName: string,
  userReferralCode: string,
  totalIncome: number,
  payoutAmount: number,
  deduction: number,
  bankAccount: {
    accountHolderName: string,
    accountNumber: string,
    bankName: string,
    ifscCode: string,
    branch: string
  },
  status: 'pending' | 'completed' | 'rejected',
  payoutDate: timestamp,
  generatedAt: timestamp,
  payoutCycle: string,
  autoGenerated: boolean
}
```

### 2. `payoutSummaries` Collection
```javascript
{
  date: timestamp,
  totalPayouts: number,
  totalAmount: number,
  totalDeductions: number,
  payoutCycle: string,
  status: string,
  autoGenerated: boolean
}
```

### 3. `users` Collection Updates
```javascript
{
  kycCompleted: boolean,
  kycCompletedAt: timestamp
}
```

### 4. `mlmUsers` Collection Updates
```javascript
{
  promotionalIncome: 0,
  leadershipIncome: 0,
  rewardsIncome: 0,
  dailyPairs: 0,
  dailyIncome: 0,
  lastPayoutDate: timestamp,
  lastPayoutAmount: number
}
```

## Admin Dashboard Features

### 1. Payout Management Page
- **Route**: `/admin/payouts`
- **Access**: Admin only
- **Features**:
  - View all payouts with complete details
  - Filter and search functionality
  - Status updates (pending → completed/rejected)
  - Excel export with bank details
  - Manual payout generation
  - Real-time statistics

### 2. Statistics Display
- Total payouts count
- Total payout amount
- Pending payouts count
- Completed payouts count
- Average payout amount

## User Dashboard Updates

### 1. Bank Account Alert
- Red ribbon alert if no bank account is added
- Warning that payouts won't be generated without bank details
- Direct link to KYC page to add bank account

### 2. Payout Information
- Next payout date display
- Days until next payout
- Automatic payout notification
- Income reset notification

## Deployment Instructions

### 1. Deploy Cloud Functions
```bash
cd functions
npm install
firebase deploy --only functions
```

### 2. Set Admin Secret Key (Optional)
```bash
firebase functions:config:set admin.secret_key="your-secret-key"
```

### 3. Test Manual Payout Generation
```bash
curl -X POST https://your-project.cloudfunctions.net/manualPayoutGeneration \
  -H "Authorization: Bearer your-secret-key"
```

## Security Considerations

1. **Authentication**: Admin functions require secret key authentication
2. **Data Validation**: All input data is validated before processing
3. **Error Handling**: Comprehensive error handling and logging
4. **Transaction Safety**: Uses Firestore transactions for data consistency

## Monitoring and Logging

1. **Cloud Function Logs**: Available in Firebase Console
2. **Payout Summaries**: Stored in `payoutSummaries` collection
3. **Error Tracking**: All errors are logged with context
4. **Performance Monitoring**: Function execution times and memory usage tracked

## Future Enhancements

1. **Email Notifications**: Send payout notifications to users
2. **SMS Notifications**: Send SMS alerts for large payouts
3. **Payout History**: User-facing payout history page
4. **Advanced Analytics**: Detailed payout analytics and reporting
5. **Bulk Operations**: Bulk payout status updates
6. **Audit Trail**: Complete audit trail for all payout operations

## Troubleshooting

### Common Issues:

1. **Payouts not generating**: Check Cloud Function logs and KYC completion status
2. **Income not resetting**: Verify MLM user data exists and is being updated
3. **Bank account issues**: Ensure primary bank account is set correctly
4. **Permission errors**: Check Firebase security rules and admin authentication

### Debug Steps:

1. Check Cloud Function logs in Firebase Console
2. Verify user KYC completion status
3. Confirm bank account exists and is primary
4. Check MLM user data for income calculations
5. Validate payout cycle calculations 